<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8"/>
		<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"/>
		<link rel="stylesheet" href= "/css/myTeam.css" type="text/css" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"/>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
		<title>myTeam/Index</title>
	    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	</head>
	<body>
		<nav class="navbar navbar-inverse navbar-static-top">
	        <div class="container">
	            <div class="navbar-header">
	                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-controls="navbar">
	                    <span class="sr-only">Toggle navigation</span>
	                    <span class="icon-bar"/>
	                    <span class="icon-bar"/>
	                    <span class="icon-bar"/>
	                </button>
	                <a class="navbar-brand" href="myTeam.html">NBADex</a>
	            </div>
	            <div class="collapse navbar-collapse">
	                <ul class="nav navbar-nav navbar-right">
	                    <li class="active"><a href="myTeam.html">My Team</a></li>
	                    <li><a href="managePlayers.html">Player Management</a></li>
	                    <li><a href="myTeamStats.html">View Stats</a></li>
	                    <li><a href="seasonSimulation.html">Simulate Season</a></li>
	                    <li><a href="" id="LogOut">Log Out</a></li>
	                </ul>
	            </div>
	        </div>
	    </nav>
	    <div class="container">
	    	<h1 id="teamName"></h1>
				<div class="row first">
					<div class="col-md-2 col-md-offset-1">
						<div class="centerBlock" id="player1">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2 ">
						<div class="centerBlock" id="player2">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2">
						<div class="centerBlock" id="player3">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2">
						<div class="centerBlock" id="player4">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2">
						<div class="centerBlock" id="player5">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
				</div>
				<div class="row second">
					<div class="col-md-2 col-md-offset-1">
						<div class="centerBlock" id="player6">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2">
						<div class="centerBlock" id="player7">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2">
						<div class="centerBlock" id="player8">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2">
						<div class="centerBlock" id="player9">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
					<div class="col-md-2">
						<div class="centerBlock" id="player10">
							<label>Position</label>
							<img src="../img/avatar.jpg" class="img-responsive" data-toggle="none" data-target="#removePlayerModal"/>
							<label>Choose Player</label>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" role="dialog" id="removePlayerModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>
				<div class="modal-body">
					<p>Remove from Team?</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal" onclick="removePlayer()">OK</button>
				</div>
			</div>
		</div>
	</div>
	</body>
	<footer class="footer">
		<div class="container-fluid">
			<div class="row">
				<div class="col-md-2 col-md-offset-10">
					<dl>
						<dt>Created By</dt>
						<dd>Juhyun James Oh</dd>
						<dd>Zhisheng Lie</dd>
						<dd>Kevin Kim</dd>
					</dl>
					<p>&copy; NBADex</p>
				</div>
			</div>
		</div>
	</footer>
	<script src="https://www.gstatic.com/firebasejs/3.7.0/firebase.js"></script>
	<script type="text/javascript">
		/*Import Firebase app*/
		var config = {
		apiKey: "AIzaSyCcIuaDuAx9NFJKzBj4FkuR3e320eGuS_g",
		authDomain: "nbadex-ff8cf.firebaseapp.com",
		databaseURL: "https://nbadex-ff8cf.firebaseio.com",
		storageBucket: "nbadex-ff8cf.appspot.com",
		messagingSenderId: "172457613001"
		};
		firebase.initializeApp(config);
		const auth = firebase.auth();

		var playerToDelete;

		/*Sign out functionality*/
		$(document).ready(function(){   
			$('#LogOut').click(function() {
			    event.preventDefault();
    		    firebase.auth().signOut();
			});
		});

		/*Checks if user exists*/
        firebase.auth().onAuthStateChanged(user => {
            if(user){
                var teamName = "Team " + user.displayName;
                document.getElementById("teamName").innerHTML = teamName;

                var email, uid;
                email = user.email;
                uid = user.uid; 

                var usersRef = firebase.database().ref('users');

                //check if user/ has a child node with the name of uid
                usersRef.once('value').then(function(snapshot) {
                    var hasID = snapshot.child(String(uid)).exists();

                    if (hasID) {
                    	/*Populate the user's team from Firebase*/                       
                        populateTeam(uid);
                    }else {
                    	/*Add blank players to the user's team*/
                        var tempJson = {};
                        var tempPic = '../img/avatar.jpg';
                        var player1 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        				,'position': 'Position'};
                        var player2 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};
                        var player3 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};
                        var player4 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};
                        var player5 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'}; 
                        var player6 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};
                        var player7 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};                            				                           			
                        var player8 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};  
                        var player9 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};  
                        var player10 = {'playerName': 'Choose Player',
                        				'img': tempPic
                        			,'position': 'Position'};                              				                            				
                        tempJson[uid] = {'username': email,
                    					player1,
                    					player2,
                    					player3,
                    					player4,
                    					player5,
                    					player6,
                    					player7,
                    					player8,
                    					player9,
                    					player10};
                        var database = firebase.database();
                        database.ref('users').update(tempJson);
                    }
                });
            }
            else{
            	/*If logging out, then there is no user. So send back to index*/
            	window.location = '../index.html';
            }
        });	
        
        /*Populates the view for the user's team from the database*/
        function populateTeam(uid){
           	firebase.database().ref('users/'+uid).once('value').then(function(snapshot){
           		snapshot.forEach(function(childSnapshot){
           			if((childSnapshot.key).includes('player')){
             			var player = document.getElementById(childSnapshot.key);
                		player.children[0].innerHTML = childSnapshot.val().position;
                		player.children[1].src = childSnapshot.val().img;
                		if(childSnapshot.val().position == 'Position')
                			player.children[1].setAttribute("data-toggle", "none");
                		else{
                			player.children[1].setAttribute("data-toggle", "modal");
                		}
                		player.children[2].innerHTML = childSnapshot.val().playerName;
                		}
                });
            });
        }        
        /*Removed the player from the team and update the view*/
        function removePlayer() {
            var user = firebase.auth().currentUser;
            var uid = user.uid;

            var blankPlayer = {
                'playerName': 'Choose Player',
                'img': '../img/avatar.jpg',
                'position': 'Position'
            }
            firebase.database().ref('users/'+uid+'/'+playerToDelete).update(blankPlayer);
            var player = document.getElementById(playerToDelete);
            player.children[0].innerHTML = 'Position';
            player.children[1].src = '../img/avatar.jpg';
            player.children[1].setAttribute('data-toggle','none');
            player.children[2].innerHTML = 'Choose Player';
        }

        /*Need to remember which player to delete when clicking modal*/
        $(document).on("click", ".img-responsive", function(){
        	playerToDelete = $(this).parent().attr('id');
        	//console.log(playerToDelete);
        });

	</script>
</body>
</html>

